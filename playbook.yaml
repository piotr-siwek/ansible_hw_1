- name: Minimal LAMP demo
  hosts: web_server
  vars:
    database_name: lamp_demo
    database_user: lamp_user
    database_password: lamp_password

  roles:
    - role: base
      tags: ["base"]
    - role: web
      tags: ["web"]
    - role: php
      tags: ["php"]
    - role: database
      tags: ["database"]
    - role: app
      tags: ["app"]

  post_tasks:
    - name: Assert debug settings match environment policy
      ansible.builtin.assert:
        that:
          - (env_name == 'dev' and app_debug | bool) or
            (env_name != 'dev' and not (app_debug | bool))
        fail_msg: "Tryb debug nie zgadza się z oczekiwaniami dla środowiska {{ env_name }}."
      tags: ["tests"]

    - name: Assert PHP error visibility follows policy
      ansible.builtin.assert:
        that:
          - ((app_debug | bool) and php_display_errors == 'On') or
            (not (app_debug | bool) and php_display_errors == 'Off')
        fail_msg: "Ustawienia PHP display_errors są niespójne ze środowiskiem {{ env_name }}."
      tags: ["tests"]

    - name: Assert HTTP port matches expectation
      ansible.builtin.assert:
        that:
          - web_listen_port == assert_expected_port
        fail_msg: "Serwer WWW nasłuchuje na porcie {{ web_listen_port }}, oczekiwano {{ assert_expected_port }}."
      tags: ["tests"]
